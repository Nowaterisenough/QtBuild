# =============================================================================
# Qt 6 Linux x86_64 GCC Build Matrix
# Standardized workflow using dedicated build scripts
# =============================================================================

name: build-qt6-native-linux_x86_64_gcc_matrix

on:
  workflow_dispatch:
    inputs:
      qt_version:
        description: 'Qt Version'
        required: true
        default: '6.10.0'
        type: string
      compiler_version:
        description: 'Compiler Version'
        required: true
        default: '15.2'
        type: choice
        options:
        - '11'
        - '12'
        - '13'
        - '14'
        - '15.2'
      vulkan_sdk:
        description: 'Vulkan support (none/runtime-*)'
        required: true
        type: choice
        options:
        - 'none'
        - 'runtime-1.3.290.0'
        - 'runtime-1.4.321.0'
        default: 'runtime-1.4.321.0'
      test_mode:
        description: 'Test mode (build qtbase only)'
        required: true
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

env:
  QT_VERSION: ${{ github.event.inputs.qt_version || '6.10.0' }}
  COMPILER_VERSION: ${{ github.event.inputs.compiler_version || '15.2' }}
  VULKAN_CHOICE: ${{ github.event.inputs.vulkan_sdk || 'runtime-1.4.321.0' }}
  TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        link_type: [static, shared]
        build_type: [release, debug, release-sepdbg]
        exclude:
          - link_type: static
            build_type: debug
          - link_type: static
            build_type: release-sepdbg

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup WSL2
        uses: Vampire/setup-wsl@v3
        with:
          distribution: Ubuntu-24.04
          use-cache: 'false'
          set-as-default: 'true'

      - name: Cache GCC 15.2
        if: ${{ env.COMPILER_VERSION == '15.2' }}
        uses: actions/cache@v4
        with:
          path: gcc-15.2-install.tar.xz
          key: gcc-15.2-ubuntu2404-${{ runner.os }}

      - name: Copy scripts to WSL
        shell: pwsh
        run: |
          # Convert Windows path to WSL path
          $wslPath = wsl wslpath "'${{ github.workspace }}'"
          Write-Host "WSL workspace path: $wslPath"

          # Copy scripts to WSL home directory and make executable
          wsl bash -c "cd ~ && cp '$wslPath/Qt6Build/setup-wsl-gcc.sh' . && cp '$wslPath/Qt6Build/download-qt-source.sh' . && cp '$wslPath/Qt6Build/build-qt6-native-linux_x86_64_gcc.sh' . && chmod +x *.sh && ls -la *.sh"

      - name: Setup WSL environment
        shell: pwsh
        run: wsl bash -c "cd ~ && ./setup-wsl-gcc.sh '${{ env.COMPILER_VERSION }}' '${{ env.VULKAN_CHOICE }}'"

      - name: Download Qt source
        shell: pwsh
        run: wsl bash -c "cd ~ && ./download-qt-source.sh '${{ env.QT_VERSION }}'"

      - name: Build Qt
        shell: pwsh
        run: |
          $buildType = "${{ matrix.build_type }}"
          $linkType = "${{ matrix.link_type }}"

          # Handle release-sepdbg
          $actualBuildType = $buildType
          $separateDebug = "false"
          if ($buildType -eq "release-sepdbg") {
            $actualBuildType = "release"
            if ($linkType -eq "shared") {
              $separateDebug = "true"
            }
          }

          # Set database environment variables in WSL and run build script from home directory
          wsl bash -c "cd ~ && export PostgreSQL_ROOT=/usr && export MYSQL_ROOT=/usr && ./build-qt6-native-linux_x86_64_gcc.sh '${{ env.QT_VERSION }}' '${{ env.COMPILER_VERSION }}' '$actualBuildType' '$linkType' '$separateDebug' '${{ env.VULKAN_CHOICE }}' '${{ env.TEST_MODE }}'"

      - name: Export config.summary
        shell: pwsh
        run: |
          $reportName = "qt-build-report_${{ matrix.link_type }}_${{ matrix.build_type }}.txt"

          # Check for config.summary in WSL output directory
          $summaryExists = wsl bash -c "cd ~ && test -f output/config.summary && echo 'true' || echo 'false'"

          if ($summaryExists.Trim() -eq "true") {
            Write-Host "Found config.summary in ~/output/"
            # Copy from WSL to Windows workspace
            wsl bash -c "cd ~ && cp output/config.summary /tmp/config.summary"
            wsl cp /tmp/config.summary "$reportName"
          } else {
            Write-Host "WARNING: config.summary not found, creating basic report"
            $qtVersion = "${{ env.QT_VERSION }}"
            $compilerVersion = "${{ env.COMPILER_VERSION }}"
            $buildTypeVal = "${{ matrix.build_type }}"
            $linkTypeVal = "${{ matrix.link_type }}"
            $testMode = "${{ env.TEST_MODE }}"
            $vulkan = "${{ env.VULKAN_CHOICE }}"
            $buildDate = Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC'

            $basicReport = "Qt $qtVersion Linux GCC $compilerVersion Build Report`n" +
                          "Build Type: $buildTypeVal`n" +
                          "Link Type: $linkTypeVal`n" +
                          "Compiler: GCC $compilerVersion`n" +
                          "Platform: Linux x86_64 (WSL2)`n" +
                          "Test Mode: $testMode`n" +
                          "Vulkan: $vulkan`n" +
                          "Build Date: $buildDate"
            [System.IO.File]::WriteAllText($reportName, $basicReport, [System.Text.UTF8Encoding]::new($false))
          }

          echo "REPORT_FILE=$reportName" >> $env:GITHUB_ENV

      - name: Package binaries
        shell: pwsh
        run: |
          $linkType = "${{ matrix.link_type }}"
          $buildType = "${{ matrix.build_type }}"

          # Normalize build type name
          $buildTypeNormalized = switch ($buildType) {
            "release" { "release" }
            "debug" { "debug" }
            "release-sepdbg" { "relwithdebinfo" }
            default { $buildType.ToLower() }
          }

          # Create standardized archive name
          $archiveName = "qt${{ env.QT_VERSION }}-linux-x86_64-gcc${{ env.COMPILER_VERSION }}-${linkType}_${buildTypeNormalized}.tar.xz"

          Write-Host "Creating archive: $archiveName"

          # Create archive from WSL home directory's output folder
          wsl bash -c "cd ~ && tar -cJf '$archiveName' -C output ."

          # Convert WSL path to Windows path
          $wslPath = wsl wslpath "'${{ github.workspace }}'"

          # Copy archive to Windows workspace
          wsl bash -c "cd ~ && cp '$archiveName' '$wslPath/'"

          if (Test-Path $archiveName) {
            $size = (Get-Item $archiveName).Length
            Write-Host "Archive created: $size bytes"
            echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_ENV
          } else {
            Write-Error "Failed to create archive"
            exit 1
          }

      - name: Upload package
        uses: actions/upload-artifact@v4
        with:
          name: qt${{ env.QT_VERSION }}-linux-x86_64-gcc${{ env.COMPILER_VERSION }}-${{ matrix.link_type }}_${{ matrix.build_type == 'release' && 'release' || matrix.build_type == 'debug' && 'debug' || 'relwithdebinfo' }}
          path: ${{ env.ARCHIVE_NAME }}
          if-no-files-found: error

      - name: Upload build report
        uses: actions/upload-artifact@v4
        with:
          name: report-${{ matrix.link_type }}_${{ matrix.build_type }}
          path: ${{ env.REPORT_FILE }}
          if-no-files-found: error
